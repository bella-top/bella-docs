"use strict";(self.webpackChunkdocs_site=self.webpackChunkdocs_site||[]).push([[5521],{7034:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>X,frontMatter:()=>a,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"bella-queue/api/worker","title":"Worker \u5f00\u53d1\u63a5\u5165\u6307\u5357","description":"\u672c\u6587\u6863\u4ecb\u7ecd\u5982\u4f55\u5f00\u53d1Worker\u670d\u52a1\u63a5\u5165Bella-Queue\u7cfb\u7edf\uff0c\u4f5c\u4e3a\u4efb\u52a1\u5904\u7406\u7684\u4e0b\u6e38\u670d\u52a1\u3002","source":"@site/docs/bella-queue/api/worker.md","sourceDirName":"bella-queue/api","slug":"/bella-queue/api/worker","permalink":"/docs/bella-queue/api/worker","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"documentationSidebar","previous":{"title":"\u4ecb\u7ecd\uff08Introduction\uff09","permalink":"/docs/bella-queue/intro"},"next":{"title":"\u6ce8\u518c\u961f\u5217","permalink":"/docs/bella-queue/api/queue/register"}}');var l=r(4848),i=r(8453);const a={},t="Worker \u5f00\u53d1\u63a5\u5165\u6307\u5357",c={},d=[{value:"Worker\u5f00\u53d1\u65b9\u5f0f",id:"worker\u5f00\u53d1\u65b9\u5f0f",level:2},{value:"1. \u51c6\u5907\u5de5\u4f5c\uff1a\u961f\u5217\u548c\u6e20\u9053\u914d\u7f6e",id:"1-\u51c6\u5907\u5de5\u4f5c\u961f\u5217\u548c\u6e20\u9053\u914d\u7f6e",level:2},{value:"1.1 \u6ce8\u518cWorker\u961f\u5217",id:"11-\u6ce8\u518cworker\u961f\u5217",level:3},{value:"1.2 \u914d\u7f6e\u6a21\u578b\u6e20\u9053",id:"12-\u914d\u7f6e\u6a21\u578b\u6e20\u9053",level:3},{value:"1.3 \u4efb\u52a1\u8def\u7531\u8bf4\u660e",id:"13-\u4efb\u52a1\u8def\u7531\u8bf4\u660e",level:3},{value:"\u76f4\u63a5\u6307\u5b9a\u961f\u5217\uff08Task API\uff09",id:"\u76f4\u63a5\u6307\u5b9a\u961f\u5217task-api",level:4},{value:"\u6279\u91cf\u4efb\u52a1\u8def\u7531\uff08Batch API\uff09",id:"\u6279\u91cf\u4efb\u52a1\u8def\u7531batch-api",level:4},{value:"2. \u81ea\u90e8\u7f72\u670d\u52a1\u63a5\u5165",id:"2-\u81ea\u90e8\u7f72\u670d\u52a1\u63a5\u5165",level:2},{value:"2.1 Worker\u670d\u52a1\u5f00\u53d1",id:"21-worker\u670d\u52a1\u5f00\u53d1",level:3},{value:"2.1.1 \u83b7\u53d6\u7cfb\u7edf\u914d\u7f6e",id:"211-\u83b7\u53d6\u7cfb\u7edf\u914d\u7f6e",level:4},{value:"2.1.2 \u62c9\u53d6\u4efb\u52a1",id:"212-\u62c9\u53d6\u4efb\u52a1",level:4},{value:"2.1.3 \u5904\u7406\u4efb\u52a1\u5e76\u8fd4\u56de\u7ed3\u679c",id:"213-\u5904\u7406\u4efb\u52a1\u5e76\u8fd4\u56de\u7ed3\u679c",level:4},{value:"Callback/Batch\u6a21\u5f0f - HTTP\u63a5\u53e3\u8fd4\u56de",id:"callbackbatch\u6a21\u5f0f---http\u63a5\u53e3\u8fd4\u56de",level:5},{value:"Blocking/Streaming\u6a21\u5f0f - Redis\u4e8b\u4ef6\u8fd4\u56de",id:"blockingstreaming\u6a21\u5f0f---redis\u4e8b\u4ef6\u8fd4\u56de",level:5},{value:"3. Java SDK\u63a5\u5165",id:"3-java-sdk\u63a5\u5165",level:2},{value:"3.1 \u6dfb\u52a0\u4f9d\u8d56",id:"31-\u6dfb\u52a0\u4f9d\u8d56",level:3},{value:"3.2 \u542f\u7528Worker",id:"32-\u542f\u7528worker",level:3},{value:"3.3 \u914d\u7f6eOpenAiService",id:"33-\u914d\u7f6eopenaiservice",level:3},{value:"3.4 \u5b9e\u73b0TaskExecutor",id:"34-\u5b9e\u73b0taskexecutor",level:3},{value:"\u63a5\u53e3\u5b9a\u4e49",id:"\u63a5\u53e3\u5b9a\u4e49",level:4},{value:"TaskWrapper\u65b9\u6cd5\u8bf4\u660e",id:"taskwrapper\u65b9\u6cd5\u8bf4\u660e",level:4},{value:"\u5b9e\u73b0\u793a\u4f8b",id:"\u5b9e\u73b0\u793a\u4f8b",level:4},{value:"3.5 \u914d\u7f6eWorker\u8c03\u5ea6\u6267\u884c\u5668",id:"35-\u914d\u7f6eworker\u8c03\u5ea6\u6267\u884c\u5668",level:3},{value:"\u4f7f\u7528\u9ed8\u8ba4ScheduledWorker",id:"\u4f7f\u7528\u9ed8\u8ba4scheduledworker",level:4},{value:"\u914d\u7f6e\u53c2\u6570\u8bf4\u660e",id:"\u914d\u7f6e\u53c2\u6570\u8bf4\u660e",level:4},{value:"3.6 \u81ea\u5b9a\u4e49Worker\u8c03\u5ea6\u6267\u884c\u5b9e\u73b0",id:"36-\u81ea\u5b9a\u4e49worker\u8c03\u5ea6\u6267\u884c\u5b9e\u73b0",level:3}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"worker-\u5f00\u53d1\u63a5\u5165\u6307\u5357",children:"Worker \u5f00\u53d1\u63a5\u5165\u6307\u5357"})}),"\n",(0,l.jsx)(n.p,{children:"\u672c\u6587\u6863\u4ecb\u7ecd\u5982\u4f55\u5f00\u53d1Worker\u670d\u52a1\u63a5\u5165Bella-Queue\u7cfb\u7edf\uff0c\u4f5c\u4e3a\u4efb\u52a1\u5904\u7406\u7684\u4e0b\u6e38\u670d\u52a1\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"worker\u5f00\u53d1\u65b9\u5f0f",children:"Worker\u5f00\u53d1\u65b9\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"\u7cfb\u7edf\u652f\u6301\u4e24\u79cdWorker\u5f00\u53d1\u65b9\u5f0f\uff1a"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u81ea\u90e8\u7f72\u670d\u52a1\u63a5\u5165"}),"\uff1a\u72ec\u7acb\u5f00\u53d1\u7684HTTP\u670d\u52a1\uff0c\u901a\u8fc7API\u4e0eBella-Queue\u4ea4\u4e92"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Java SDK\u63a5\u5165"}),"\uff1a\u4f7f\u7528Bella-Queue\u63d0\u4f9b\u7684Java SDK\u5feb\u901f\u96c6\u6210"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"1-\u51c6\u5907\u5de5\u4f5c\u961f\u5217\u548c\u6e20\u9053\u914d\u7f6e",children:"1. \u51c6\u5907\u5de5\u4f5c\uff1a\u961f\u5217\u548c\u6e20\u9053\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"\u5f00\u53d1Worker\u524d\uff0c\u9700\u8981\u5148\u5728Bella-Queue\u4e2d\u6ce8\u518c\u961f\u5217\u5e76\u914d\u7f6e\u6e20\u9053\u6620\u5c04\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"11-\u6ce8\u518cworker\u961f\u5217",children:"1.1 \u6ce8\u518cWorker\u961f\u5217"}),"\n",(0,l.jsx)(n.p,{children:"\u4e3aWorker\u670d\u52a1\u6ce8\u518c\u4e00\u4e2a\u961f\u5217\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'curl -X POST "https://${Host}/v1/queue/register" \\\n  -H "Content-Type: application/json" \\\n  -H "Authorization: Bearer ${apikey}" \\\n  -d \'{\n    "queue": "deepseek-r1",\n    "endpoint": "/v1/chat/completions"\n  }\'\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u53c2\u6570\u8bf4\u660e"})}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u53c2\u6570"}),(0,l.jsx)(n.th,{children:"\u7c7b\u578b"}),(0,l.jsx)(n.th,{children:"\u5fc5\u9700"}),(0,l.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"queue"})}),(0,l.jsx)(n.td,{children:"string"}),(0,l.jsx)(n.td,{children:"Required"}),(0,l.jsx)(n.td,{children:"\u961f\u5217\u540d\u79f0\uff08\u53ea\u80fd\u5305\u542b\u5b57\u6bcd\u3001\u6570\u5b57\u3001\u4e0b\u5212\u7ebf\u3001\u5206\u9694\u7b26\uff0c\u957f\u5ea6\u4e0d\u8d85\u8fc764\u5b57\u7b26\uff09"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"endpoint"})}),(0,l.jsx)(n.td,{children:"string"}),(0,l.jsx)(n.td,{children:"Required"}),(0,l.jsx)(n.td,{children:"\u5904\u7406\u4efb\u52a1\u7684\u80fd\u529b\u70b9"})]})]})]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u54cd\u5e94"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'"deepseek-r1"\n'})}),"\n",(0,l.jsx)(n.h3,{id:"12-\u914d\u7f6e\u6a21\u578b\u6e20\u9053",children:"1.2 \u914d\u7f6e\u6a21\u578b\u6e20\u9053"}),"\n",(0,l.jsx)(n.p,{children:"\u901a\u8fc7OpenAPI\u521b\u5efa\u6e20\u9053\uff08Channel\uff09\uff0c\u5efa\u7acb\u6a21\u578b\u540d\u79f0\u4e0e\u961f\u5217\u7684\u6620\u5c04\u5173\u7cfb\u3002"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u4f5c\u7528"}),"\uff1a\u5f53\u7528\u6237\u4f7f\u7528\u7279\u5b9a\u6a21\u578b\u65f6\uff0cBella-Queue\u4f1a\u6839\u636e\u6e20\u9053\u914d\u7f6e\u5c06\u4efb\u52a1\u81ea\u52a8\u8def\u7531\u5230\u5bf9\u5e94\u7684\u961f\u5217\u3002"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u6e20\u9053\u914d\u7f6e\u7684\u5177\u4f53\u63a5\u53e3\u548c\u53c2\u6570\u8bf7\u53c2\u8003OpenAPI\u63a5\u53e3\u6587\u6863\u3002"})}),"\n",(0,l.jsx)(n.h3,{id:"13-\u4efb\u52a1\u8def\u7531\u8bf4\u660e",children:"1.3 \u4efb\u52a1\u8def\u7531\u8bf4\u660e"}),"\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e\u5b8c\u6210\u540e\uff0cBella-Queue\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u5c06\u4efb\u52a1\u653e\u5165\u5bf9\u5e94\u7684\u961f\u5217\uff0cWorker\u4ece\u961f\u5217\u4e2d\u62c9\u53d6\u4efb\u52a1\u8fdb\u884c\u5904\u7406\uff1a"}),"\n",(0,l.jsx)(n.h4,{id:"\u76f4\u63a5\u6307\u5b9a\u961f\u5217task-api",children:"\u76f4\u63a5\u6307\u5b9a\u961f\u5217\uff08Task API\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'curl -X POST "https://${Host}/v1/queue/put" \\\n  -H "Content-Type: application/json" \\\n  -H "Authorization: Bearer ${apikey}" \\\n  -d \'{\n    "queue": "deepseek-r1",\n    "endpoint": "/v1/chat/completions",\n    "level": 1,\n    "data": {\n        "model": "deepseek-r1-20250401",\n        "messages": [\n        {\n          "role": "user",\n          "content": "\u4f60\u597d"\n        }\n      ],\n      "stream": false\n    },\n    "callback_url": "http://localhost:8081/test/callback",\n  }\'\n'})}),"\n",(0,l.jsx)(n.h4,{id:"\u6279\u91cf\u4efb\u52a1\u8def\u7531batch-api",children:"\u6279\u91cf\u4efb\u52a1\u8def\u7531\uff08Batch API\uff09"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u6307\u5b9a\u961f\u5217"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'curl -X POST "https://${Host}/v1/batches" \\\n  -H "Content-Type: application/json" \\\n  -H "X-BELLA-QUEUE-NAME: deepseek-r1" \\\n  -H "Authorization: Bearer ${apikey}" \\\n  -d \'{\n    "input_file_id": "file-XXXXXXXXXXXXXXXXXXXXXXX-XXXXXXXXXX",\n    "endpoint": "/v1/chat/completions", \n    "completion_window": "24h",\n    "metadata": {\n      "description": "Customer support chat completions batch"\n    }\n  }\'\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u81ea\u52a8\u8def\u7531"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'curl -X POST "https://${Host}/v1/batches" \\\n  -H "Content-Type: application/json" \\\n  -H "Authorization: Bearer ${apikey}" \\\n  -d \'{\n    "input_file_id": "file-XXXXXXXXXXXXXXXXXXXXXXX-XXXXXXXXXX",\n    "endpoint": "/v1/chat/completions", \n    "completion_window": "24h",\n    "metadata": {\n      "description": "Customer support chat completions batch"\n    }\n  }\'\n'})}),"\n",(0,l.jsx)(n.p,{children:"input_file\u4e2d\u7684\u6bcf\u4e00\u884c\u8bf7\u6c42\u793a\u4f8b\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-jsonl",children:'{"custom_id": "req-1", "method": "POST", "url": "/v1/chat/completions", "body": {"model": "deepseek-r1", "messages": [...]}}\n'})}),"\n",(0,l.jsxs)(n.p,{children:["\u7cfb\u7edf\u6839\u636e",(0,l.jsx)(n.code,{children:"deepseek-r1"}),"\u6a21\u578b\u81ea\u52a8\u67e5\u627e\u6e20\u9053\u914d\u7f6e\uff0c\u8def\u7531\u5230",(0,l.jsx)(n.code,{children:"deepseek-r1"}),"\u961f\u5217\u3002"]}),"\n",(0,l.jsx)(n.h2,{id:"2-\u81ea\u90e8\u7f72\u670d\u52a1\u63a5\u5165",children:"2. \u81ea\u90e8\u7f72\u670d\u52a1\u63a5\u5165"}),"\n",(0,l.jsx)(n.p,{children:"\u9002\u5408\u5df2\u6709\u63a8\u7406\u670d\u52a1\u6216\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u6280\u672f\u6808\u7684\u573a\u666f\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"21-worker\u670d\u52a1\u5f00\u53d1",children:"2.1 Worker\u670d\u52a1\u5f00\u53d1"}),"\n",(0,l.jsx)(n.p,{children:"Worker\u670d\u52a1\u9700\u8981\u5b9e\u73b0\u4ee5\u4e0b\u6838\u5fc3\u529f\u80fd\uff1a"}),"\n",(0,l.jsx)(n.h4,{id:"211-\u83b7\u53d6\u7cfb\u7edf\u914d\u7f6e",children:"2.1.1 \u83b7\u53d6\u7cfb\u7edf\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"\u83b7\u53d6EventBus\u914d\u7f6e\uff0c\u7528\u4e8e\u5b9e\u65f6\u4efb\u52a1\u901a\u4fe1\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'curl -X GET "https://${Host}/v1/queue/eventbus" \\\n  -H "Authorization: Bearer ${apikey}"\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u54cd\u5e94\u793a\u4f8b"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "url": "redis://localhost:6379",\n  "topic": "bella:eventbus:"\n}\n'})}),"\n",(0,l.jsx)(n.h4,{id:"212-\u62c9\u53d6\u4efb\u52a1",children:"2.1.2 \u62c9\u53d6\u4efb\u52a1"}),"\n",(0,l.jsx)(n.p,{children:"\u5b9a\u671f\u4eceBella-Queue\u62c9\u53d6\u5f85\u5904\u7406\u4efb\u52a1\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'curl -X POST "https://${Host}/v1/queue/take" \\\n  -H "Content-Type: application/json" \\\n  -H "Authorization: Bearer ${apikey}" \\\n  -d \'{\n    "queues": [\n        "deepseek-r1:1"\n    ],\n    "size": 10,\n    "strategy": "fifo"\n  }\'\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u54cd\u5e94\u793a\u4f8b\uff08\u79bb\u7ebf\u961f\u5217 - Batch/Callback\u6a21\u5f0f\uff09"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "deepseek-r1:1": [\n    {\n      "ak": "xxx",\n      "endpoint": "/v1/chat/completions",\n      "queue": "test-queue",\n      "level": 1,\n      "data": {\n        "model": "deepseek-r1",\n        "messages": [\n          {\n            "role": "user",\n            "content": "Hello"\n          }\n        ],\n        "temperature": 0.7\n      },\n      "status": "waiting",\n      "task_id": "TASK-X-X-X-XXXXXXXXXXXX-XXXX-XXXXXX",\n      "batch_id": "BATCH-X-X-XXXXXXXXXXXX-XXXX-XXXXXX",\n      "trace_id": "BATCH-X-X-XXXXXXXXXXXX-XXXX-XXXXXX",\n      "start_time": 1762863595000,\n      "running_time": 0,\n      "expire_time": 1762949994000,\n      "completed_time": 0,\n      "callback_url": "",\n      "response_mode": "batch"\n    }\n  ]\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u54cd\u5e94\u793a\u4f8b\uff08\u5728\u7ebf\u961f\u5217 - Blocking/Streaming\u6a21\u5f0f\uff09"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "deepseek-r1:0": [\n    {\n      "ak": "xxx",\n      "endpoint": "/v1/chat/completions",\n      "queue": "test-queue",\n      "level": 0,\n      "data": {\n        "model": "deepseek-r1",\n        "messages": [\n          {\n            "role": "user",\n            "content": "\u4f60\u597d"\n          }\n        ],\n        "stream": false\n      },\n      "task_id": "TASK-X-X-X-XXXXXXXXXXXX-XXXX-XXXXXX",\n      "instance_id": "xx.xx.xx.xx:xxxx",\n      "start_time": 1762950826730,\n      "running_time": 0,\n      "expire_time": 1762951126730,\n      "completed_time": 0,\n      "response_mode": "blocking"\n    }\n  ]\n}\n'})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"instanceId\u8bf4\u660e"}),"\uff1a\u5728\u7ebf\u4efb\u52a1\u4f1a\u643a\u5e26",(0,l.jsx)(n.code,{children:"instance_id"}),"\u5b57\u6bb5\uff0c\u6807\u8bc6\u53d1\u8d77\u8bf7\u6c42\u7684\u5ba2\u6237\u7aef\u5b9e\u4f8b\u5730\u5740\uff08\u5982IP:\u7aef\u53e3\uff09\uff0cWorker\u5904\u7406\u5b8c\u6210\u540e\u9700\u8981\u5411Redis\nStream\u53d1\u9001\u4e8b\u4ef6\u5230\u5bf9\u5e94\u7684\u5b9e\u4f8b\u3002"]}),"\n",(0,l.jsx)(n.h4,{id:"213-\u5904\u7406\u4efb\u52a1\u5e76\u8fd4\u56de\u7ed3\u679c",children:"2.1.3 \u5904\u7406\u4efb\u52a1\u5e76\u8fd4\u56de\u7ed3\u679c"}),"\n",(0,l.jsxs)(n.p,{children:["\u6839\u636e",(0,l.jsx)(n.code,{children:"response_mode"}),"\u91c7\u7528\u4e0d\u540c\u7684\u7ed3\u679c\u8fd4\u56de\u65b9\u5f0f\uff1a"]}),"\n",(0,l.jsx)(n.h5,{id:"callbackbatch\u6a21\u5f0f---http\u63a5\u53e3\u8fd4\u56de",children:"Callback/Batch\u6a21\u5f0f - HTTP\u63a5\u53e3\u8fd4\u56de"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'curl -X POST "https://${Host}/v1/queue/{taskId}/complete" \\\n  -H "Content-Type: application/json" \\\n  -H "Authorization: Bearer ${apikey}" \\\n  -d \'{\n    "status_code": 200,\n    "request_id": "TASK-X-X-X-XXXXXXXXXXXX-XXXX-XXXXXX",\n    "body": {\n      // Worker\u5904\u7406\u7ed3\u679c - chat completion\u54cd\u5e94\n      "id": "chatcmpl-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",\n      "object": "chat.completion",\n      "model": "deepseek-r1",\n      "choices": [{\n        "message": {\n          "role": "assistant", \n          "content": "Hello! How can I help you today?"\n        }\n      }]\n    }\n  }\'\n'})}),"\n",(0,l.jsx)(n.h5,{id:"blockingstreaming\u6a21\u5f0f---redis\u4e8b\u4ef6\u8fd4\u56de",children:"Blocking/Streaming\u6a21\u5f0f - Redis\u4e8b\u4ef6\u8fd4\u56de"}),"\n",(0,l.jsxs)(n.p,{children:["\u5728\u7ebf\u4efb\u52a1\u643a\u5e26",(0,l.jsx)(n.code,{children:"instance_id"}),"\u5b57\u6bb5\uff0cWorker\u9700\u8981\u901a\u8fc7Redis Stream\u53d1\u9001\u4e8b\u4ef6\u5230\uff1a",(0,l.jsx)(n.code,{children:"{eventbus.topic}{instance_id}"})]}),"\n",(0,l.jsxs)(n.p,{children:['\u4f8b\u5982\uff1aeventbus.topic = "bella:eventbus:"\uff0cinstance_id = "192.168.1.100:8080"\n\u5219\u53d1\u9001\u5230\uff1a',(0,l.jsx)(n.code,{children:"bella:eventbus:192.168.1.100:8080"})]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u8fdb\u5ea6\u4e8b\u4ef6"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "name": "task-progress-event",\n  "from": "",\n  "payload": {\n    "taskId": "TASK-X-X-X-XXXXXXXXXXXX-XXXX-XXXXXX",\n    "eventId": "progress-1",\n    "eventName": "chunk",\n    "eventData": {\n      "delta": {\n        "content": "Hello"\n      }\n    }\n  },\n  "context": ""\n}\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u5b8c\u6210\u4e8b\u4ef6"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "name": "task-completion-event",\n  "from": "",\n  "payload": {\n    "taskId": "TASK-X-X-X-XXXXXXXXXXXX-XXXX-XXXXXX",\n    "result": {\n      "status_code": 200,\n      "request_id": "TASK-X-X-X-XXXXXXXXXXXX-XXXX-XXXXXX",\n      "body": {\n        "id": "chatcmpl-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",\n        "object": "chat.completion",\n        "choices": [\n          {\n            "message": {\n              "role": "assistant",\n              "content": "Hello! How can I help you today?"\n            }\n          }\n        ]\n      }\n    }\n  },\n  "context": ""\n}\n'})}),"\n",(0,l.jsx)(n.h2,{id:"3-java-sdk\u63a5\u5165",children:"3. Java SDK\u63a5\u5165"}),"\n",(0,l.jsx)(n.p,{children:"\u9002\u5408Java\u6280\u672f\u6808\u7684\u5e94\u7528\uff0c\u53ef\u4ee5\u5feb\u901f\u96c6\u6210\u5230Spring Boot\u9879\u76ee\u4e2d\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"31-\u6dfb\u52a0\u4f9d\u8d56",children:"3.1 \u6dfb\u52a0\u4f9d\u8d56"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-xml",children:"\n<dependency>\n    <groupId>top.bella</groupId>\n    <artifactId>openapi-spi</artifactId>\n    <version>1.1.68</version>\n</dependency>\n"})}),"\n",(0,l.jsx)(n.h3,{id:"32-\u542f\u7528worker",children:"3.2 \u542f\u7528Worker"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"\n@SpringBootApplication\n@EnableWorker\npublic class WorkerApplication {\n    public static void main(String[] args) {\n        SpringApplication.run(WorkerApplication.class, args);\n    }\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"33-\u914d\u7f6eopenaiservice",children:"3.3 \u914d\u7f6eOpenAiService"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'\n@Configuration\npublic class OpenAiConfig {\n\n    @Value("${openai.base-url}")\n    private String baseUrl;\n\n    @Value("${openai.token}")\n    private String token;\n\n    @Bean\n    public OpenAiService openAiService() {\n        return new OpenAiService(token, baseUrl);\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"34-\u5b9e\u73b0taskexecutor",children:"3.4 \u5b9e\u73b0TaskExecutor"}),"\n",(0,l.jsx)(n.p,{children:"TaskExecutor\u662fWorker\u5904\u7406\u4efb\u52a1\u7684\u6838\u5fc3\u63a5\u53e3\uff0c\u5b9a\u4e49\u4e86\u4efb\u52a1\u63d0\u4ea4\u6267\u884c\u548c\u5bb9\u91cf\u7ba1\u7406\u7684\u5951\u7ea6\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"\u63a5\u53e3\u5b9a\u4e49",children:"\u63a5\u53e3\u5b9a\u4e49"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"public interface TaskExecutor {\n    /**\n     * \u63d0\u4ea4\u4efb\u52a1\u5904\u7406\n     * @param task \u4efb\u52a1\u5305\u88c5\u5668\uff0c\u5305\u542b\u4efb\u52a1\u6570\u636e\u548c\u72b6\u6001\u7ba1\u7406\u65b9\u6cd5\n     */\n    void submit(TaskWrapper task);\n\n    /**\n     * \u8fd4\u56de\u5f53\u524d\u53ef\u5904\u7406\u7684\u4efb\u52a1\u6570\u91cf\n     * Worker\u53ef\u6839\u636e\u8be5\u53c2\u6570\u52a8\u6001\u8c03\u6574\u62c9\u53d6\u4efb\u52a1\u7684\u6570\u91cf\n     * @return \u5269\u4f59\u5bb9\u91cf\uff0c\u8fd4\u56de0\u65f6\u4e0d\u4f1a\u62c9\u53d6\u65b0\u4efb\u52a1\n     */\n    Integer remainingCapacity();\n}\n"})}),"\n",(0,l.jsx)(n.h4,{id:"taskwrapper\u65b9\u6cd5\u8bf4\u660e",children:"TaskWrapper\u65b9\u6cd5\u8bf4\u660e"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"getPayload()"}),": \u83b7\u53d6\u4e0a\u6e38\u63d0\u4ea4\u7684\u4efb\u52a1\u6570\u636e\uff08Map\u683c\u5f0f\uff09"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"markComplete(Object result)"}),": \u6807\u8bb0\u4efb\u52a1\u5b8c\u6210\uff0c\u4f20\u5165\u5904\u7406\u7ed3\u679c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"markRetryLater()"}),": \u6807\u8bb0\u4efb\u52a1\u7a0d\u540e\u91cd\u8bd5"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"emitProgress()"}),": \u53d1\u9001\u8fdb\u5ea6\u4e8b\u4ef6\uff08streaming\u6a21\u5f0f\uff09"]}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"\u5b9e\u73b0\u793a\u4f8b",children:"\u5b9e\u73b0\u793a\u4f8b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:'\n@Component\npublic class TaskExecutorImpl implements TaskExecutor {\n\n    @Override\n    public void submit(TaskWrapper task) {\n        try {\n            // \u83b7\u53d6\u4efb\u52a1\u6570\u636e\n            Map<String, Object> data = task.getPayload();\n\n            // \u5224\u65ad\u4efb\u52a1\u7c7b\u578b\n            String responseMode = (String) data.get("responseMode");\n\n            if("streaming".equals(responseMode)) {\n                // Streaming\u4efb\u52a1\u5904\u7406\n                Map<String, Object> result = Map.of("content", "Processing...");\n                // \u53d1\u9001\u8fdb\u5ea6\u4e8b\u4ef6\n                task.emitProgress("onProgress", "onProgress", result);\n                // \u5982\u679c\u5b8c\u6210\uff0c\u6807\u8bb0\u4efb\u52a1\u5b8c\u6210\n                task.markComplete(Map.of());\n            } else {\n                // \u5176\u4ed6\u4efb\u52a1\u5904\u7406\n                Object result = Map.of("result", "success");\n                // \u6807\u8bb0\u4efb\u52a1\u5b8c\u6210\n                task.markComplete(result);\n            }\n        } catch (Exception e) {\n            // \u5904\u7406\u5931\u8d25\n            if(shouldRetry(e)) {\n                task.markRetryLater();\n            } else {\n                task.markComplete(Map.of(\n                        "error", Map.of(\n                                "message", e.getMessage(),\n                                "type", "processing_error"\n                        )\n                ));\n            }\n        }\n    }\n\n    @Override\n    public Integer remainingCapacity() {\n        return 10;\n    }\n\n    private boolean shouldRetry(Exception e) {\n        // \u5224\u65ad\u662f\u5426\u5e94\u8be5\u91cd\u8bd5\n        return false;\n    }\n}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"35-\u914d\u7f6eworker\u8c03\u5ea6\u6267\u884c\u5668",children:"3.5 \u914d\u7f6eWorker\u8c03\u5ea6\u6267\u884c\u5668"}),"\n",(0,l.jsx)(n.p,{children:"\u9ed8\u8ba4\u63d0\u4f9b\u57fa\u4e8e\u5b9a\u65f6\u8f6e\u8be2\u7684ScheduledWorker\uff0c\u901a\u8fc7\u914d\u7f6e\u6587\u4ef6\u542f\u7528\u5e76\u914d\u7f6e\u8c03\u5ea6\u53c2\u6570\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"\u4f7f\u7528\u9ed8\u8ba4scheduledworker",children:"\u4f7f\u7528\u9ed8\u8ba4ScheduledWorker"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'bella:\n  queue:\n    worker:\n      enabled: true\n      scheduled:\n        enabled: true\n        take-strategy: fifo\n        size: 10\n        queues:\n          - "my-task-queue:0"\n          - "my-task-queue:1"\n'})}),"\n",(0,l.jsx)(n.h4,{id:"\u914d\u7f6e\u53c2\u6570\u8bf4\u660e",children:"\u914d\u7f6e\u53c2\u6570\u8bf4\u660e"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"enabled"}),": \u662f\u5426\u542f\u7528ScheduledWorker\u8c03\u5ea6\u5668"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"queues"}),': \u76d1\u542c\u7684\u961f\u5217\u5217\u8868\uff0c\u683c\u5f0f\u4e3a"\u961f\u5217\u540d:\u4f18\u5148\u7ea7"\uff0c\u6570\u5b57\u8d8a\u5c0f\u4f18\u5148\u7ea7\u8d8a\u9ad8\uff0c\u4f1a\u6839\u636e\u914d\u7f6e\u987a\u5e8f\u62c9\u53d6\u4efb\u52a1']}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"size"}),": \u6bcf\u6b21\u62c9\u53d6\u7684\u6700\u5927\u4efb\u52a1\u6570\uff0c\u5b9e\u9645\u6570\u91cf\u53d6TaskExecutor.remainingCapacity()\u548csize\u4e4b\u95f4\u7684\u5c0f\u503c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"take-strategy"}),": \u961f\u5217\u62c9\u53d6\u7b56\u7565","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"fifo"}),": \u5148\u8fdb\u5148\u51fa\uff0c\u6309\u7167\u4efb\u52a1\u5165\u961f\u65f6\u95f4\u5148\u540e\u62c9\u53d6\uff0c\u5165\u961f\u8d8a\u65e9\u4f18\u5148\u7ea7\u8d8a\u9ad8\uff0c\u6700\u591a\u53ea\u80fd\u62c9\u53d610\u4e2a"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"round_robin"}),": \u8f6e\u8be2\u6a21\u5f0f\uff0c\u5728\u591a\u4e2a\u961f\u5217\u95f4\u8f6e\u6d41\u62c9\u53d6"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"active_passive"}),": \u4e3b\u5907\u6a21\u5f0f\uff0c\u4f18\u5148\u62c9\u53d6\u4e3b\u961f\u5217\uff0c\u4e3b\u961f\u5217\u65e0\u4efb\u52a1\u65f6\u62c9\u53d6\u5907\u961f\u5217"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"sequential"}),": \u5168\u5c40\u987a\u5e8f\u6267\u884c\uff0c\u786e\u4fdd\u6bcf\u4e2a\u961f\u5217\u540c\u4e00\u65f6\u95f4\u53ea\u80fd\u6709\u4e00\u4e2a\u4efb\u52a1\u5728\u8fd0\u884c\uff0c\u6bcf\u4e2a\u961f\u5217\u53ea\u62c9\u53d6\u4e00\u4e2a\u4efb\u52a1"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"36-\u81ea\u5b9a\u4e49worker\u8c03\u5ea6\u6267\u884c\u5b9e\u73b0",children:"3.6 \u81ea\u5b9a\u4e49Worker\u8c03\u5ea6\u6267\u884c\u5b9e\u73b0"}),"\n",(0,l.jsx)(n.p,{children:"\u5982\u679c\u9ed8\u8ba4\u7684ScheduledWorker\u4e0d\u6ee1\u8db3\u9700\u6c42\uff0c\u53ef\u4ee5\u590d\u7528\u5df2\u5b9e\u4f8b\u5316\u7684Worker\u7ec4\u4ef6\uff0c\u81ea\u5b9a\u4e49\u62c9\u53d6\u4efb\u52a1\u8c03\u5ea6\u6267\u884c\u903b\u8f91\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-java",children:"\n@Component\npublic class CustomWorkerScheduler {\n\n    @Autowired\n    private Worker worker;\n\n    @Scheduled(fixedDelay = 1000)\n    public void pullAndProcessTasks() {\n        // \u81ea\u5b9a\u4e49\u4efb\u52a1\u62c9\u53d6\u548c\u5904\u7406\u903b\u8f91\n        worker.pullAndProcess();\n    }\n}\n"})})]})}function X(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(o,{...e})}):o(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>t});var s=r(6540);const l={},i=s.createContext(l);function a(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);